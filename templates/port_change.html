<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>端口维护</title>
    <link href="{{static_url('plugins/bootstrap-sweetalert/sweet-alert.css')}}" rel="stylesheet" type="text/css">
    <link href="{{static_url('plugins/datatables/jquery.dataTables.min.css')}}" rel="stylesheet" type="text/css"/>
    <link href="{{static_url('plugins/datatables/responsive.bootstrap.min.css')}}" rel="stylesheet" type="text/css"/>
    <link href="{{static_url('plugins/datatables/scroller.bootstrap.min.css')}}" rel="stylesheet" type="text/css"/>
    <link href="{{static_url('plugins/datatables/dataTables.bootstrap.min.css')}}" rel="stylesheet" type="text/css"/>
    <link href="{{static_url('plugins/jquery.filer/css/jquery.filer.css')}}" rel="stylesheet" />
    <style>
        #example{
            width: 100% !important;
        }

        .modal-lg-port {
            width:40%;
            height:45%;
            margin-left:30%;
            margin-top:300px;
        }


    </style>
</head>
<body>
     <p></p>
     <div class="col-md-12">
       <div class="col-md-3 input-group">
            <span class="input-group-addon"><i class="mdi mdi-server"></i></span>
            <input type="text" id="appname" class="form-control" placeholder="请输入应用名">
            <span class="input-group-btn">
               <button type="button"  id='query_btn' class="btn waves-effect waves-light btn-primary"><i class="fa fa-search"></i></button>
            </span>
       </div>
       <p></p>
       <div id="div-tab">
           <table id="example" class="table table-striped table-bordered dt-responsive nowrap" cellspacing="0" width="100%"  height="100%" ></table>
       </div>
       <div class="col-md-offset-4 col-lg-offset-4 col-xl-offset-4">
           <input  id='portupd' type='button' class="btn waves-effect waves-light btn-primary" value="变更"/>
           <input  id='portdel' type='button' class="btn waves-effect waves-light btn-primary" value="删除"/>
           <input  id='portimp' type='button' class="btn waves-effect waves-light btn-primary" value="导入"/>
           <input  id='portexp' type='button' class="btn waves-effect waves-light btn-primary" value="导出"/>
       </div>
      </div>

    <!--导入窗口 -->
    <div id="con-close-modal-imp" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
       <div class="modal-dialog modal-lg-port">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">端口导入</h4>
            </div>
            <div class="modal-body">
                <div class="panel panel-flat">
                    <div class="panel-body">
                       <form class="form-horizontal" action=""  method="POST" enctype="multipart/form-data" >
                            <div class="row">
                               <div class="form-group">
                                    <div>
                                        <label class="col-md-3 control-label">文件名</label>
                                    </div>
                                    <div class="col-md-9">
                                        <input type="file" name="files[]" id="filer_imp"  multiple="multiple">
                                    </div>
                               </div>
                            </div>
                       </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="col-sm-offset-3 col-sm-4">
                       <button type="button" class="btn btn-custom waves-effect waves-light btn-md" id="start_imp" >开始</button>
                       <button type="button" class="btn btn-custom waves-effect waves-light btn-md" data-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
     </div>
    </div><!-- /.modal -->
    </div>

   <script src="{{static_url('plugins/datatables/jquery.dataTables.min.js')}}"></script>
   <script src="{{static_url('plugins/datatables/dataTables.bootstrap.js')}}"></script>
   <script src="{{static_url('plugins/datatables/dataTables.buttons.min.js')}}"></script>
   <script src="{{static_url('plugins/datatables/buttons.bootstrap.min.js')}}"></script>
   <script src="{{static_url('plugins/datatables/dataTables.responsive.min.js')}}"></script>
   <script src="{{static_url('plugins/datatables/responsive.bootstrap.min.js')}}"></script>
   <script src="{{static_url('plugins/bootstrap-sweetalert/sweet-alert.min.js')}}"></script>
   <script src="{{static_url('plugins/jquery.filer/js/jquery.filer2.js')}}"></script>

   <script>
        $(document).keydown(function(event){
            if (event.keyCode == 13) { //判断为Enter键
                $("#query_btn").click();
            }
         });

        $("#appname").bind("input propertychange",function(){
           $("#query_btn").click();
        });

        $("#query_btn").click(function() {
              $.ajax({
                  url: "/port/_query",
                  type: "post",
                  datatype: "json",
                  data:{
                      app_name: $('#appname').val()
                  },
                  success: function (dataSet) {
                    $('#example').DataTable( {
                      "stripeClasses": [ 'cell-border', 'cell-border', 'cell-border' ],
                      "dom"      : '<"top"<"clear">>rt<"bottom"ip<"clear">>',
                      destroy    :true,
                      async      :true,
                      scrollY    :true,
                      scrollX    :true,
                      scrollCollapse: true,
                      paging:     true,
                      iDisplayLength: 14,
                      data: dataSet,
                      columns: [
                        { "title": "标识符" ,"visible":true},
                        { "title": "应用名" },
                        { "title": "端口号" },
                        { "title": "开发者" },
                        { "title": "应用描述" },
                        { "title": "附加信息" },
                        {
                            "title":"选择",
                            "width": "25px",
                            "render": function(data,type,row){
                                 return '<input type="radio" name="userid" onclick="isSelect();" >'; }
                        },
                      ],
                      "language": {
                             "search"       : "在表格中搜索:",
                             "sProcessing"  : "处理中...",
                             "sLengthMenu"  : "显示 _MENU_ 项结果",
                             "sZeroRecords" : "没有匹配结果",
                             "sInfo"        : "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
                             "sInfoEmpty"   : "显示第 0 至 0 项结果，共 0 项",
                             "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
                             "sInfoPostFix" : "",
                             "sSearch"      : "搜索:",
                             "sUrl"         : "",
                             "sEmptyTable"  : "表中数据为空",
                             "sLoadingRecords": "载入中...",
                             "sInfoThousands": ",",
                             "oPaginate": {
                                 "sFirst"   : "首页",
                                 "sPrevious": "上页",
                                 "sNext"    : "下页",
                                 "sLast"    : "末页"
                             },
                             "oAria": {
                                 "sSortAscending" : ": 以升序排列此列",
                                 "sSortDescending": ": 以降序排列此列"
                             }
                         }
                     });
                 }
             });
            });

        $('#portupd').on('click', function() {
             var portid='';
             $("#example tbody tr td input:checked").each( function() {
                  var row=$(($(this).parent().parent().html()));
                  portid=row[0].innerHTML;
                  console.log("portid=",portid)
             });
             $('#main-container-div').load("/port/edit?port_id="+portid);
        });

        $('#portdel').on('click', function() {
             var portid='';
             var portidame='';
             $("#example tbody tr td input:checked").each( function() {
                  var row = $(($(this).parent().parent().html()));
                  portid  = row[0].innerHTML;
                  portidame=row[2].innerHTML;
                  console.log("portid=",portid,"portidame=",portidame)
             });
            swal({
                title: "确认要删除吗?",
                text: "服务器["+portidame+"]不能使用了！",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "是, 删除!",
                cancelButtonText:  "否, 撤销!",
                closeOnConfirm: false,
                closeOnCancel: false
             }, function (isConfirm) {
                if (isConfirm) {
                    $.ajax({
                            url: "/port/edit/del?port_id="+portid,
                            type: "post",
                            datatype: "json",
                            success: function (dataSet) {
                                //console.log(dataSet.code, dataSet.message);
                                if (dataSet.code=='0') {
                                    swal("已注销!", "服务器["+portidame+"]已删除!", "success");
                                    $("#query_btn").click();
                                } else {
                                    swal("注销失败!", "服务器["+portidame+"]"+dataSet.message+"!", "error");
                                }
                            }
                       });

                } else {
                    swal("已取消", "服务器["+portidame+"]未删除！", "error");
                }
            });
        });

        $('#portimp').on('click',function () {
            $('#filer_imp').val('')
            $('#con-close-modal-imp').modal({
                   keyboard: false,
                   backdrop:false
           });
         })

        $('#portexp').on('click',function () {
            $.ajax({
                url: "/port/edit/exp",
                type: "post",
                datatype: "json",
                success: function (dataSet) {
                    console.log('message=', dataSet.message, 'code=', dataSet.code);
                    var link = $("<a/>")
                    link.html('　');
                    link.attr('href', dataSet.message);
                    link.attr('class', 'link');
                    link.attr('id', 'download_id');
                    link.attr('name', 'download_name');
                    link.appendTo('body')
                    link[0].click();
                }
            })
         })

        $("#start_imp").click(function () {

            if ($('#filer_imp').val() == '' ) {

                swal("文件名不能为空!", "", "error")
                return false
            }

            var fd = new FormData();
            files  = $("#filer_imp").get(0).files;
            fd.append("file", files[0]);
            $.ajax({
                url: "/port/edit/imp",
                type: "POST",
                processData: false,
                contentType: false,
                data : fd,
                async:false,
                dataType: 'JSON',
                success: function (dataSet) {
                   console.log(dataSet.message);
                   if (dataSet.code =='0') {
                       swal("导入成功", "", "success")
                   } else {
                       swal("导入失败", "", "error")
                   }
                }
            });
          });

        $('#filer_imp').filer({
                limit: 1,
                maxSize: 3,
                extensions: ['xls', 'xlsx'],
                changeInput: true,
                showThumbs: true,
                addMore: true
         });

        $('#filer_exp').filer({
                limit: 1,
                maxSize: 3,
                extensions: ['xls', 'xlsx'],
                changeInput: true,
                showThumbs: true,
                addMore: true
         });

        $(document).ready(function() {

            $("#query_btn").click();

        });

   </script>
</body>

</html>